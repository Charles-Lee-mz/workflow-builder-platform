# 部署说明

## 快速开始

### 环境要求
- Python 3.8+
- Node.js 16+
- MySQL 5.7+ 或 SQLite（开发环境）
- Redis（可选，用于缓存）

### 后端部署

#### 1. 安装依赖
```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
# Windows
venv\Scripts\activate
# Linux/Mac
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

#### 2. 配置环境变量
创建 `.env` 文件：
```env
# 数据库配置
DATABASE_URL=sqlite:///workflow_engine.db
# 或使用 MySQL
# DATABASE_URL=mysql://username:password@localhost/workflow_db

# 安全配置
SECRET_KEY=your-secret-key-here

# AI模型配置
QWEN_API_KEY=your-qwen-api-key

# 服务配置
FLASK_HOST=127.0.0.1
FLASK_PORT=5001
FLASK_DEBUG=True
```

#### 3. 启动后端服务
```bash
python run.py
```

### 前端部署

#### 1. 安装依赖
```bash
cd frontend
npm install
```

#### 2. 启动开发服务器
```bash
npm start
```

#### 3. 构建生产版本
```bash
npm run build
```

## 详细配置

### 后端配置 (config.py)

```python
# 数据库配置
SQLALCHEMY_DATABASE_URI = 'mysql://user:pass@localhost/db'
SQLALCHEMY_TRACK_MODIFICATIONS = False

# 缓存配置
CACHE_TYPE = 'redis'
CACHE_REDIS_URL = 'redis://localhost:6379/0'

# Celery 配置（异步任务）
CELERY_BROKER_URL = 'redis://localhost:6379/1'
CELERY_RESULT_BACKEND = 'redis://localhost:6379/2'

# AI 模型配置
QWEN_BASE_URL = "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions"
QWEN_API_KEY = "your-api-key"
QWEN_MODEL = "qwen-turbo"
```

### 前端配置

#### 环境变量 (.env)
```env
REACT_APP_API_BASE_URL=http://localhost:5001
REACT_APP_WS_URL=ws://localhost:5001
REACT_APP_VERSION=1.0.0
```

#### 代理配置 (package.json)
```json
{
  "proxy": "http://localhost:5001"
}
```

## API 文档

### 主要 API 端点

#### 认证相关
- `POST /api/auth/login` - 用户登录
- `POST /api/auth/logout` - 用户登出
- `GET /api/auth/profile` - 获取用户信息

#### 工作流管理
- `GET /api/workflow/list` - 获取工作流列表
- `POST /api/workflow/create` - 创建工作流
- `PUT /api/workflow/{id}` - 更新工作流
- `DELETE /api/workflow/{id}` - 删除工作流
- `POST /api/workflow/{id}/execute` - 执行工作流

#### 意图识别
- `POST /api/intent/detect` - 检测用户意图
- `GET /api/intent/list` - 获取意图列表

#### 节点类型
- `GET /api/workflow/node-types` - 获取支持的节点类型

#### 模型配置
- `GET /api/models/configs` - 获取模型配置
- `POST /api/models/configs` - 更新模型配置

### API 文档访问
启动后端服务后，访问：
- Swagger UI: `http://localhost:5001/docs`
- ReDoc: `http://localhost:5001/redoc`

## Docker 部署

### 后端 Dockerfile
```dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

EXPOSE 5001

CMD ["python", "run.py"]
```

### 前端 Dockerfile
```dockerfile
FROM node:16-alpine as build

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=build /app/build /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

### Docker Compose
```yaml
version: '3.8'

services:
  backend:
    build: .
    ports:
      - "5001:5001"
    environment:
      - DATABASE_URL=mysql://root:password@db:3306/workflow_db
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - db
      - redis

  frontend:
    build: ./frontend
    ports:
      - "3000:80"
    depends_on:
      - backend

  db:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=password
      - MYSQL_DATABASE=workflow_db
    volumes:
      - mysql_data:/var/lib/mysql

  redis:
    image: redis:alpine
    ports:
      - "6379:6379"

volumes:
  mysql_data:
```

### 启动 Docker 服务
```bash
docker-compose up -d
```

## 故障排除

### 常见问题

#### 1. 数据库连接失败
```bash
# 检查数据库服务状态
sudo systemctl status mysql

# 检查连接字符串
echo $DATABASE_URL

# 测试连接
mysql -h localhost -u username -p
```

#### 2. 前端无法连接后端
- 检查后端服务是否启动：`curl http://localhost:5001/health`
- 检查 CORS 配置
- 检查代理设置

#### 3. AI 模型调用失败
- 检查 API 密钥是否正确
- 检查网络连接
- 查看错误日志

### 日志查看

#### 后端日志
```bash
# 查看应用日志
tail -f logs/app.log

# 查看错误日志
tail -f logs/error.log
```

#### 前端日志
- 浏览器开发者工具 Console
- Network 标签页查看 API 请求

#### Docker 日志
```bash
# 查看容器日志
docker-compose logs -f backend
docker-compose logs -f frontend
```

## 生产环境部署

### 安全配置
1. 使用强密码和密钥
2. 启用 HTTPS
3. 配置防火墙
4. 定期更新依赖
5. 使用环境变量管理敏感信息

### 性能优化
1. 启用 Redis 缓存
2. 配置数据库连接池
3. 使用 CDN 加速静态资源
4. 启用 Gzip 压缩
5. 配置负载均衡

### 监控和维护
1. 设置日志轮转
2. 配置监控告警
3. 定期备份数据库
4. 监控系统资源使用
5. 设置健康检查

### 推荐的生产环境架构
```
[负载均衡器] -> [Web服务器] -> [应用服务器] -> [数据库]
     |              |              |              |
   Nginx         Nginx        Gunicorn      MySQL
                              + Flask     + Redis
```

---

📝 **提示**: 生产环境部署前请仔细测试所有功能，确保安全配置正确。